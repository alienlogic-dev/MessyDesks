(function(){function t(t,o){var n={};void 0===o&&(o=t,t={}),e=t.container||this.parent()||e;var a=this;if(r=t.markers||this.parent()||r,n.source=a,n.target=o,n.type=t.type||"straight",t.connector){var c=SVG.get(t.connector.node.attributes.href.value.slice(1));if("path"==c.type){n.connector=t.connector;var i=c.array().value;if("M"!=i[1][0]||"M"!=i[2][0]){var l=c.rbox();i.splice(0,0,["M",l.x+l.width/2,l.y],["M",l.x+l.width/2,l.y2]),c.plot(i)}n.connector.target=c}}return n.connector||(n.connector=e.path().attr("connectortype","default").fill("none")),n.sourceAttach=t.sourceAttach||"center",n.targetAttach=t.targetAttach||"center",n.color=t.color||"#000000",n.setMarker=function(t,e,r){if(r=r||this,e&&(r.markers=e),t&&"null"!=t)if("default"==t){var t=r.markers.marker(30,30),o="triangle-"+Math.random().toString(16);r.connector.attr("marker-end","url(#"+o+")"),t.attr({id:o,viewBox:"0 0 30 30",refX:"30",refY:"15",markerUnits:"strokeWidth",markerWidth:"12",markerHeight:"15"}),t.path().attr({d:"M 0 0 L 30 15 L 0 30 z"}),r.marker=t,r.marker.fill(r.color)}else r.marker=t;else if(r.marker=null,r.connector.attr("marker-end")){var n=r.connector.attr("marker-end");SVG.get(n.slice(5,n.length-1)).remove(),r.connector.removeClass("marker-end")}return r},n.setMarker(t.marker,r),n.computeConnectorCoordinates=function(t){t=t||this;var e={},r=t.source.rbox(),o=t.target.rbox();if("center"==t.sourceAttach)e.point1=[t.source.cx(),t.source.cy()];else if("ellipse"==t.source.type){var n=parseFloat(t.source.attr("rx")),a=parseFloat(t.source.attr("ry")),c=t.source.cx(),i=t.source.cy(),l=t.target.cx(),s=t.target.cy(),h=l-c,p=s-i,g=Math.sqrt(h*h+p*p),u=h/g,y=p/g,x=c+n*u,f=i+a*y;e.point1=[x+n/2,f+a/2]}else if("path"==t.source.type){var v=JSON.parse(JSON.stringify(t.source.array().value));"Z"==v[v.length-1][0]&&v.splice(v.length-1,1);var m=v,d="point2"}else var v=[["M",t.source.cx(),t.source.y()],["L",t.source.x()+r.width,t.source.cy()],["L",t.source.cx(),t.source.y()+r.height],["L",t.source.x(),t.source.cy()]],m=v,d="point2";if("center"==t.targetAttach)e.point2=[t.target.cx(),t.target.cy()];else if("ellipse"==t.target.type){var M=parseFloat(t.target.attr("rx")),k=parseFloat(t.target.attr("ry")),c=t.source.cx(),i=t.source.cy(),l=t.target.cx(),s=t.target.cy(),h=l-c,p=s-i,g=Math.sqrt(h*h+p*p),u=h/g,y=p/g,C=c+(g-M-5)*u,w=i+(g-k-5)*y;e.point2=[C+M/2,w+k/2]}else if("path"==t.target.type){var A=JSON.parse(JSON.stringify(t.target.array().value));"Z"==A[A.length-1][0]&&A.splice(A.length-1,1);var m=A,d="point1"}else var A=[["M",t.target.cx(),t.target.y()],["L",t.target.x()+o.width,t.target.cy()],["L",t.target.cx(),t.target.y()+o.height],["L",t.target.x(),t.target.cy()]],m=A,d="point1";if(!e.point1||!e.point2)if(e.min=Number.MAX_VALUE,e.point1||e.point2){d=e[d];for(var L=0;L<m.length;L++){var S=Math.pow(d[0]-m[L][m[L].length-2],2)+Math.pow(d[1]-m[L][m[L].length-1],2);e.min>S&&(e.min=S,e.point=[m[L][m[L].length-2],m[L][m[L].length-1]])}e.point1?e.point2=e.point:e.point1=e.point}else for(var L=0;L<v.length;L++)for(var b=0;b<A.length;b++){var S=Math.pow(A[b][A[b].length-2]-v[L][v[L].length-2],2)+Math.pow(A[b][A[b].length-1]-v[L][v[L].length-1],2);e.min>S&&(e.min=S,e.point1=[v[L][v[L].length-2],v[L][v[L].length-1]],e.point2=[A[b][A[b].length-2],A[b][A[b].length-1]])}var V=e.point1,G=e.point2;if("curved"==t.type){var N=(G[1]-V[1])/4,O=0>N?-1:1;N=Math.max(Math.abs(N),20);var q={x:V[0],y:V[1]+O*N},F={x:G[0],y:G[1]-O*N},J={x:q.x+(F.x-q.x)/2,y:q.y+(F.y-q.y)/2},E=[["M",V[0],V[1]],["C",q.x,q.y,q.x,q.y,J.x,J.y],["C",F.x,F.y,F.x,F.y,G[0],G[1]]]}else var E=[["M",V[0],V[1]],["L",G[0],G[1]]];return E},a.cons=a.cons||[],a.cons.push(n),n.update=function(){if("default"==n.connector.attr("connectortype"))n.connector.plot(n.computeConnectorCoordinates(n));else{var t=n.connector.target.array().value,e=n.computeConnectorCoordinates(n),r=[e[0][1],e[0][2]],o=[e[e.length-1][e[e.length-1].length-2],e[e.length-1][e[e.length-1].length-1]],a=Math.sqrt(Math.pow(o[0]-r[0],2)+Math.pow(o[1]-r[1],2)),c=Math.sqrt(Math.pow(t[1][1]-t[0][1],2)+Math.pow(t[1][2]-t[0][2],2)),i=a/c,l=Math.atan((o[1]-r[1])/(o[0]-r[0]));l>0&&o[1]<r[1]?l=Math.PI+l:0>l&&o[1]>r[1]&&o[0]<r[0]&&(l=Math.PI+l);var s={x:r[0]+(o[0]-r[0])/2,y:r[1]+(o[1]-r[1])/2},h=Math.atan((t[1][2]-t[0][2])/(t[1][1]-t[0][1])),p={x:n.connector.target.cx(),y:n.connector.target.cy()},g=[1,0,0,1,s.x-p.x,s.y-p.y],u=g[0],y=g[1],x=g[2],f=g[3],v=g[4],m=g[5],d=Math.sin(-l+h),M=Math.cos(-l+h);v=-u*s.x-x*s.y+v,m=-y*s.x-f*s.y+m,g[0]=u*M+y*d,g[1]=-u*d+y*M,g[2]=x*M+f*d,g[3]=-x*d+M*f,g[4]=M*v+d*m,g[5]=M*m-d*v,g[4]=u*s.x+x*s.y+g[4],g[5]=y*s.x+f*s.y+g[5];var u=1,y=0,x=0,f=1,v=(-u*p.x-x*p.y)*i,m=(-y*p.x-f*p.y)*i,k=[];k[0]=u*i,k[1]=y*i,k[2]=x*i,k[3]=f*i,k[4]=u*p.x+x*p.y+v,k[5]=y*p.x+f*p.y+m;var C=[];C[0]=k[0]*g[0]+k[1]*g[2],C[1]=k[0]*g[1]+k[1]*g[3],C[2]=k[2]*g[0]+k[3]*g[2],C[3]=k[2]*g[1]+k[3]*g[3],C[4]=g[0]*k[4]+g[2]*k[5]+g[4],C[5]=g[1]*k[4]+g[3]*k[5]+g[5],C=new SVG.Matrix(C.join(",")),n.connector.transform(C)}},n.update(),a.on("dragmove",n.update),o.on("dragmove",n.update),n.setConnectorColor=function(t,e){e=e||this,e.color=t,e.connector.stroke(t),e.marker&&e.marker.fill(t)},n.setConnectorColor(n.color),n.setConnectorAttachment=function(t,e,r){r=r||this,r[t+"Attach"]=e,r.update()},n.setConnector=function(t,r){r=r||this,t&&(r.connector.remove(),"default"==t?(r.connector=e.path().attr("connectortype","default").fill("none"),r.setConnectorColor(r.color)):r.connector=t,r.update())},n.setType=function(t,e){e=e||this,-1!=["straight","curved"].indexOf(t)&&e.type!=t&&(e.type=t,e.update())},n}var e=null,r=null;SVG.extend(SVG.Element,{connectable:t})}).call(this);
