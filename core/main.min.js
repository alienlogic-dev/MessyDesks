class Pin{constructor(t,e,o,n=!0,i=!1){this.ID=e,this.component=t,this.name=o,this.isInput=n,this.isBidirectional=i,this.width=Math.round(o.length/3),this.value=null,this.svg=null}}var cycIdx=0;class Component{constructor(t,e,o=0,n=!1){this.id="",this.isSelected=!1,this.exeIdx=0,this.instName="",this.minWidth=5,this.minHeight=2,this.inputs=[],this.outputs=[];var i=0,s=0;if(o instanceof Array)for(var r=0;r<o.length;r++){(a=o[r]).length>0&&void 0===this[a]&&(this[a]=null),this.inputs.push(new Pin(this,i++,a,!0,!0)),this.outputs.push(new Pin(this,s++,a,!1,!0))}else for(r=0;r<o;r++)this.inputs.push(new Pin(this,i++,"",!0,!0)),this.outputs.push(new Pin(this,s++,"",!1,!0));if(t instanceof Array)for(r=0;r<t.length;r++){(a=t[r]).length>0&&void 0===this[a]&&(this[a]=null),this.inputs.push(new Pin(this,i++,a,!0))}else for(r=0;r<t;r++)this.inputs.push(new Pin(this,i++,"",!0));if(e instanceof Array)for(r=0;r<e.length;r++){var a;(a=e[r]).length>0&&void 0===this[a]&&(this[a]=null),this.outputs.push(new Pin(this,s++,a,!1))}else for(r=0;r<e;r++)this.outputs.push(new Pin(this,s++,"",!1));this.init(),n&&this.createSVG()}init(){}createSVG(){var t=8*this.minWidth,e=8*Math.max(this.minHeight,Math.max(2*this.inputs.length,2*this.outputs.length));this.svg=new SVG.G,this.svg.on("mousedown",this.mouseDownEvent,this),this.svg.on("mouseup",this.mouseUpEvent,this),this.svg.on("dblclick",this.dblClickEvent,this),this.svg.draggable({snapToGrid:8}),this.svg.on("dragstart",this.dragstart,this),this.svg.on("dragend",this.dragend,this),this.drawBody(t,e),this.drawPins(t,e);var o=new SVG.G;this.drawSymbol(o),o.move(t/2-o.width()/2,e/2-o.height()/2),this.svg.add(o)}drawBody(t,e){this.svgBody=this.svg.rect(t,e).radius(2).move(0,0).fill("#cccccc").stroke({color:"#666666",width:2}),this.svgName=this.svg.text(this.constructor.name.replace("_Component","")).font({family:"Menlo",size:12,anchor:"middle"}).move(t/2,-15)}drawPins(t,e){for(var o=e/this.inputs.length,n=this.inputs.length-1;n>=0;n--){(s=this.inputs[n]).isBidirectional?s.svg=this.svg.rect(8,8):s.svg=this.svg.circle(8),s.svg.move(-4,o*n+o/2-4).addClass("pin").fill("#ffcc00").stroke({color:"#000",width:1}).data("pin_id",s.ID).on("click",this.pinClickedEvent,s).on("contextmenu",this.pinRemoveWires,s),this.svg.text(s.name).font({family:"Menlo",size:9,anchor:"start"}).move(6,o*n+o/2-6)}var i=e/this.outputs.length;for(n=this.outputs.length-1;n>=0;n--){var s;(s=this.outputs[n]).isBidirectional?s.svg=this.svg.rect(8,8):s.svg=this.svg.circle(8),s.svg.move(t-4,i*n+i/2-4).fill("#fff").addClass("pin").stroke({color:"#000",width:1}).data("pin_id",s.ID).on("click",this.pinClickedEvent,s).on("contextmenu",this.pinRemoveWires,s),this.svg.text(s.name).font({family:"Menlo",size:9,anchor:"end"}).move(t-6,i*n+i/2-6)}}drawSymbol(t){}openConfig(t){t&&($("#modalComponentOptions .modal-body").html(t),$("#modalComponentOptions").off("click",".btnComponentOptionsApply"),$("#modalComponentOptions").on("click",".btnComponentOptionsApply",this,function(t){t.data.applyConfig()&&$("#modalComponentOptions").modal("hide")}),$("#modalComponentOptions").modal("show"))}applyConfig(){}createConfigModal(){}pinRemoveWires(t){t.preventDefault();var e=wires.filter(t=>t.I===this||t.O===this);for(var o in e)removeWire(e[o]);return!1}pinClickedEvent(t){if(t.shiftKey){var e=prompt("Enter value",this.value);null!=e&&""!=e&&(this.value=e)}else if(t.altKey){var o=wires.filter(t=>t.I===this||t.O===this);for(var n in o)removeWire(o[n])}else this.component.pinClicked&&this.component.pinClicked(this)}mouseDownEvent(t){}mouseUpEvent(t){}mouseDblClickEvent(t){}dblClickEvent(t){if(t.altKey)startComponentEdit(this);else{var e=this.createConfigModal();e?this.openConfig(e):this.mouseDblClickEvent(t)||startComponentEdit(this)}}dragstart(t){this.old_x=this.svg.x(),this.old_y=this.svg.y()}dragend(t){this.svg.x()==this.old_x&&this.svg.y()==this.old_y||saveUndoState()}select(){this.svgBody.stroke({color:"#0000ff",width:2}),this.isSelected=!0}deselect(){this.svgBody.stroke({color:"#666666",width:2}),this.isSelected=!1}getConfig(){return null}marshallingInputs(){for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t].name;e.length>0&&void 0!==this[e]&&(this[e]=this.inputs[t].value)}}marshallingOutputs(){for(var t=0;t<this.outputs.length;t++){var e=this.outputs[t].name;e.length>0&&void 0!==this[e]&&null!==this[e]&&(this.outputs[t].value=this[e])}}execute(){}run(){if(cycIdx>this.exeIdx){this.marshallingInputs(),this.execute(),this.marshallingOutputs(),this.guiInputs=this.inputs.map(t=>t.value).splice(0);for(var t=0;t<this.inputs.length;t++)this.inputs[t].value=null;return this.exeIdx=cycIdx,!0}return!1}getOut(t){if(void 0!==t)return this.outputs[t].value}setIn(t,e){null!=e&&(this.inputs[t].value=e)}draw(){}refresh(){for(var t in this.guiInputs)this.inputs[t].svg.fill(null==this.guiInputs[t]?"#fc0":+this.guiInputs[t]?"#0c0":"#c00");for(t=0;t<this.outputs.length;t++)this.outputs[t].svg.fill(null==this.outputs[t].value?"#fff":+this.outputs[t].value?"#0c0":"#c00");this.draw()}}Component.group="General";var wireboardWidth=256,wireboardHeight=256,draw=SVG("drawing").size(8*wireboardWidth,8*wireboardHeight);setTimeout(function(){window.scrollTo(($(document).width()-$(window).width())/2,($(document).height()-$(window).height())/2)},100);var componentsSVG=new SVG.G,wiresSVG=new SVG.G;function pointInRect(t,e){var o=t.x>=e.x2-e.w&&t.x<=e.x2,n=t.y>=e.y2-e.h&&t.y<=e.y2;return o&&n}$(document).keydown(function(t){if(!($("#modalComponentOptions").data("bs.modal")||{})._isShown){if(79==t.keyCode&&t.metaKey)return $("#file").click(),!1;if(83==t.keyCode&&t.metaKey)return saveProjectToFile(),!1;if(65==t.keyCode&&t.metaKey){for(var e in components)components[e].select();return!1}if(90==t.keyCode&&t.metaKey&&!t.shiftKey)return undo(),!1;if(90==t.keyCode&&t.metaKey&&t.shiftKey)return redo(),!1;if(8==t.keyCode){for(e=components.length-1;e>=0;e--){var o=components[e];o.isSelected&&removeComponent(o)}return!1}}}),draw.on("click",function(t){var e=null;if(!t.metaKey)for(var o in components)components[o].deselect();for(var o in components)if(pointInRect(t,components[o].svg.rbox())){e=components[o],t.metaKey&&e.isSelected?e.deselect():e.select();break}}),initWireboard();var myCodeMirror=CodeMirror.fromTextArea($("#siliconCodeArea")[0]);function initWireboard(){draw.clear();var t=draw.pattern(8,8,function(t){t.line(8,0,8,8).stroke("#ddd"),t.line(0,8,8,8).stroke("#ddd")});draw.rect(8*wireboardWidth,8*wireboardHeight).fill(t),componentsSVG.clear(),wiresSVG.clear(),draw.add(componentsSVG),draw.add(wiresSVG)}$(myCodeMirror.getWrapperElement()).addClass("hide");var components=[],componentsIdx=0;function addComponent(t){var e=new toolbox[t];e.id="c"+componentsIdx++,e.pinClicked=pinClicked,e.createSVG(),e.svg.move(8*Math.round(document.documentElement.scrollLeft/8)+200,8*Math.round(document.documentElement.scrollTop/8)+200),componentsSVG.add(e.svg),components.push(e),saveUndoState(),updateSimOrderFromWireboard(),drawSiliconbox()}function removeComponent(t){removeWiresFromComponent(t),t.svg.remove();var e=components.indexOf(t);components.splice(e,1),saveUndoState(),updateSimOrderFromWireboard(),drawSiliconbox()}var wires=[],pinSelected=null;function pinClicked(t){if(null==pinSelected)pinSelected=t;else{if(t===pinSelected)return alert("Cannot select to the same pin"),void(pinSelected=null);var e=null;if(t.isBidirectional&&pinSelected.isBidirectional)e={I:t,O:pinSelected},wires.push(e),e={I:pinSelected,O:t},wires.push({I:pinSelected,O:t});else{if(t.isInput==pinSelected.isInput)return alert("Connection allowed only for input and output"),void(pinSelected=null);e={I:t.isInput?t:pinSelected,O:t.isInput?pinSelected:t},wires.push(e)}if(e){var o=new WireConnection(pinSelected.svg,t.svg,wiresSVG);e.con=o,saveUndoState(),updateSimOrderFromWireboard()}pinSelected=null}}function removeWire(t){t.con.remove();var e=wires.indexOf(t);wires.splice(e,1),updateSimOrderFromWireboard()}function removeWiresFromComponent(t){for(var e=wires.length-1;e>=0;e--){var o=wires[e];o.I.component!==t&&o.O.component!==t||removeWire(o)}}function sourceFromWireboard(){for(var t={components:[],wires:[]},e=0;e<components.length;e++){var o=components[e],n={id:o.id,name:o.constructor.name,config:o.getConfig(),x:o.svg.x(),y:o.svg.y()};t.components.push(n)}for(e=0;e<wires.length;e++){var i=wires[e],s=i.I,r=i.O,a={O:{component:r.component.id,pin:r.ID},I:{component:s.component.id,pin:s.ID}};t.wires.push(a)}return t}function wireboardFromSource(t){for(var e in initWireboard(),components=[],wires=[],t.components){var o=t.components[e],n=new toolbox[o.name](o.config);n.id=o.id,n.pinClicked=pinClicked,n.createSVG(),n.svg.move(o.x,o.y),componentsSVG.add(n.svg),components.push(n),componentsIdx=Math.max(componentsIdx,+o.id.replace("c","")+1)}for(e=0;e<t.wires.length;e++){var i=t.wires[e],s=components.filter(t=>t.id==i.O.component),r=components.filter(t=>t.id==i.I.component);if(s.length>0&&r.length>0){var a=s[0].outputs[i.O.pin],l=r[0].inputs[i.I.pin],u={I:l,O:a};wires.push(u);var c=new WireConnection(l.svg,a.svg,wiresSVG);u.con=c}}updateSimOrderFromSource(t)}var editorCodes={},selectedEditorCode="silicon";function startEditorCode(){selectedEditorCode="silicon",myCodeMirror.doc.setValue(editorCodes[selectedEditorCode]),selectEditorCode(selectedEditorCode)}function selectEditorCode(t){editorCodes[selectedEditorCode]=myCodeMirror.doc.getValue(),editorCodes[selectedEditorCode=t]||(editorCodes[selectedEditorCode]=""),myCodeMirror.doc.setValue(editorCodes[selectedEditorCode]),$("#btnSwitchCode > button").text(t)}var wireboardSourceStack=[],componentEditStack=[];function startComponentEdit(t){if(wireboardSourceStack.push(sourceFromWireboard()),componentEditStack.push(t),t.constructor.source)inSiliconMode=!1,wireboardFromSource(t.constructor.source),drawEditbox();else{for(var e in inSiliconMode=!0,initWireboard(),components=[],wires=[],drawEditbox(),editorCodes.silicon=t.constructor.toString(),availableCompilers)editorCodes[e]=t.constructor[e];startEditorCode()}clearUndoStack()}function cancelLastComponentEdit(){wireboardSourceStack.length>0?(wireboardFromSource(wireboardSourceStack[wireboardSourceStack.length-1]),wireboardSourceStack.splice(-1,1),componentEditStack.splice(-1,1)):console.error("No editing pending!");selectEditorCode("silicon"),inSiliconMode=!1,drawEditbox(),clearUndoStack()}function endLastComponentEdit(){if(wireboardSourceStack.length>0){if(inSiliconMode){selectEditorCode("silicon");var t=applyComponentSilicon(componentEditStack[componentEditStack.length-1].constructor.name,editorCodes.silicon);for(var e in availableCompilers)editorCodes[e]&&(t[e]=editorCodes[e]);t.source=null}else newComponentFromWireboard(componentEditStack[componentEditStack.length-1].constructor.name);wireboardFromSource(wireboardSourceStack[wireboardSourceStack.length-1]),wireboardSourceStack.splice(-1,1),componentEditStack.splice(-1,1)}else console.error("No editing pending!");inSiliconMode=!1,drawEditbox(),clearUndoStack()}var inSiliconMode=!1;function switchToSilicon(){if(confirm("Do you want to switch to Silicon code?\nWARNING: Cannot be undone.")){inSiliconMode=!0,drawSiliconbox();var t=newComponentFromWireboard(componentEditStack[componentEditStack.length-1].constructor.name);for(var e in editorCodes.silicon=t.toString(),availableCompilers)editorCodes[e]=crossCompileSource(e,componentEditStack[componentEditStack.length-1].constructor.name,t.source);startEditorCode()}}function compileSource(t,e){var o=[];o.push(`class ${t} extends Component {`),o.push("\tconstructor() {");var n=[],i=[];for(var s in e.components){"INPUT"==(u=e.components[s]).name?(u.config?n.push(u.config.alias):n.push(""),0):"OUTPUT"==u.name&&(u.config?i.push(u.config.alias):i.push(""),0)}o.push(`\t\tsuper(${JSON.stringify(n)}, ${JSON.stringify(i)});`),o.push("\t}"),o.push("\tinit() {");var r={},a=0,l=0;for(var s in e.components){var u,c=(u=e.components[s]).id;"INPUT"==u.name?c=a++:"OUTPUT"==u.name?c=l++:o.push(`\t\tthis.${c} = new ${u.name}(${JSON.stringify(u.config)});`),r[u.id]=c}o.push("\t}"),o.push("\texecute() {");var p=generateExecutionOrderFromSource(e);for(var s in p){var d=p[s],h=e.wires.filter(t=>t.O.component==d.id);for(var m in"INPUT"!=d.name&&"OUTPUT"!=d.name&&o.push(`\t\tthis.${r[d.id]}.run();`),h){var v=h[m];if(v){var f=v.I,g=e.components.filter(t=>t.id==f.component)[0],C=v.O,S=e.components.filter(t=>t.id==C.component)[0],b=`this.${r[C.component]}.getOut(${C.pin})`;"INPUT"==S.name&&(b=`this.inputs[${r[S.id]}].value`);var w=`this.${r[f.component]}.setIn(${f.pin}, ${b})`;"OUTPUT"==g.name&&(w=`this.outputs[${r[g.id]}].value = ${b}`),o.push("\t\t"+w+";")}}}return o.push("\t}"),o.push("}"),o.join("\n")}function newComponentFromSource(t,e){var o=e,n=applyComponentSilicon(t,compileSource(t,o));return n.source=o,n}function newComponentFromWireboard(t){var e=newComponentFromSource(t,sourceFromWireboard());return initWireboard(),components=[],wires=[],e}function newEmptyComponent(){var t=$("#newComponentName").val();null!=t&&""!=t&&(t in toolbox?alert("Component alredy exists!"):($("#modalNewComponent").modal("hide"),newComponentFromSource(t,{components:[],wires:[]})))}function applyComponentSilicon(componentName,siliconCode){var ret=eval(`${componentName} = (${siliconCode}); ${componentName}`);return toolbox[componentName]=ret,drawGroupedToolbox(),ret}var toolbox={};function saveProject(){var t={toolbox:{},source:{}};for(var e in toolbox){var o=toolbox[e];if(o!==toolbox_original[e])if(o.source)t.toolbox[e]=o.source;else{var n={};for(var i in availableCompilers)n[i]=o[i];t.toolbox[e]={silicon:o.toString(),codes:n}}}return t.source=sourceFromWireboard(),t}function loadProject(t){loadToolboxFromProject(t),wireboardFromSource(t.source)}function loadProjectAsComponent(t,e){loadToolboxFromProject(e),newComponentFromSource(t,e.source)}function loadToolboxFromProject(t){for(var e in t.toolbox){var o=t.toolbox[e],n=null;for(var i in n=o.silicon?applyComponentSilicon(e,o.silicon):newComponentFromSource(e,o),o.codes)n[i]=o.codes[i]}}var toolbox_grouped={};function groupToolbox(){for(var t in toolbox_grouped={},toolbox){var e=toolbox[t];toolbox_grouped[e.group]||(toolbox_grouped[e.group]={expanded:!1,items:[]}),toolbox_grouped[e.group].items.push(t)}}function drawGroupedToolbox(){groupToolbox(),updateGroupedToolbox()}function updateGroupedToolbox(){var t=$("#toolbox");for(var e in t.html(""),toolbox_grouped){var o=toolbox_grouped[e],n=`<li class="list-group-item p-2 text-right list-group-item-dark" onclick="toggleExpandToolboxGroup('${e}')">${e} <span class="badge badge-pill badge-secondary">${o.items.length}</span></li>`;if(t.append(n),o.expanded)for(var i in o.items){var s=o.items[i],r=`<li class="list-group-item p-2 text-right" onclick="addComponent('${s}')">${s.replace("_Component","")}</li>`;t.append(r)}}}function toggleExpandToolboxGroup(t){var e=toolbox_grouped[t];e&&(e.expanded=!e.expanded,updateGroupedToolbox())}function drawEditbox(){for(var t in componentEditStack.length>0?($("#editbox").removeClass("hidden"),$("#btnSaveProject, #btnOpenProject, #btnSwitchCompiler, #btnCompileBoard").addClass("hide")):($("#editbox").addClass("hidden"),$("#btnSaveProject, #btnOpenProject, #btnSwitchCompiler, #btnCompileBoard").removeClass("hide")),$("#editbox .breadcrumb").html(""),componentEditStack)$("#editbox .breadcrumb").append('<li class="breadcrumb-item">'+componentEditStack[t].constructor.name.replace("_Component","")+"</li>");drawSiliconbox()}function drawSiliconbox(){for(var t in $("#btnSwitchCode > .dropdown-menu").html('<button class="dropdown-item" type="button" onclick="selectEditorCode(\'silicon\')">Silicon</button>'),availableCompilers)$("#btnSwitchCode > .dropdown-menu").append(`<button class="dropdown-item" type="button" onclick="selectEditorCode('${t}')">${t}</button>`);wireboardSourceStack.length>0?inSiliconMode?($(myCodeMirror.getWrapperElement()).removeClass("hide"),$("#drawing").addClass("hide"),$("#btnSwitchToSilicon, #btnNewComponent").addClass("hide"),$("#btnSwitchCode").removeClass("hide")):($(myCodeMirror.getWrapperElement()).addClass("hide"),$("#drawing").removeClass("hide"),$("#btnSwitchToSilicon, #btnNewComponent").removeClass("hide"),$("#btnSwitchCode").addClass("hide")):($(myCodeMirror.getWrapperElement()).addClass("hide"),$("#drawing, #btnNewComponent").removeClass("hide"),$("#btnSwitchToSilicon").addClass("hide"),$("#btnSwitchCode").addClass("hide"))}function saveProjectToFile(){download(JSON.stringify(saveProject()),"project.prj","text/plain")}var undoStack=[],undoStackPtr=0;function clearUndoStack(){undoStack=[saveProject()],undoStackPtr=0,$("#btnUndo").attr("disabled",""),$("#btnRedo").attr("disabled","")}function saveUndoState(){undoStackPtr<20?undoStack[++undoStackPtr]=saveProject():(undoStack.shift(),undoStack.push(saveProject())),$("#btnUndo").removeAttr("disabled"),$("#btnRedo").attr("disabled","")}function undo(){undoStackPtr>0&&(loadProject(undoStack[--undoStackPtr]),$("#btnRedo").removeAttr("disabled"),undoStackPtr<=0&&$("#btnUndo").attr("disabled",""))}function redo(){undoStackPtr<undoStack.length-1&&(loadProject(undoStack[++undoStackPtr]),$("#btnUndo").removeAttr("disabled"),undoStackPtr>=undoStack.length-1&&$("#btnRedo").attr("disabled",""))}clearUndoStack();var availableCompilers={},selectedCompiler="";function signNewCompiler(t,e){for(var o in availableCompilers[t]=e,$("#btnSwitchCompiler > .dropdown-menu").html(""),availableCompilers)$("#btnSwitchCompiler > .dropdown-menu").append(`<button class="dropdown-item" type="button" onclick="selectCompiler('${o}')">${o}</button>`);selectCompiler(t)}function crossCompileSource(t,e,o){return availableCompilers[t]?(0,availableCompilers[t].compileSource)(e,o):null}function crossCompile(t){if(availableCompilers[t]){var e=availableCompilers[t].framework,o=[];for(var n in toolbox){var i=toolbox[n];if(i.source){var s=crossCompileSource(t,n,i.source);o.push(s)}else i[t]&&o.push(i[t])}var r=crossCompileSource(t,"MAIN_Component",sourceFromWireboard());return o.push(r),{complete:e()+"\n\n"+o.join("\n"),framework:e(),wireboard:o.join("\n")}}return null}function selectCompiler(t){$("#btnSwitchCompiler > button").text(t),selectedCompiler=t}var simOrder=[];function updateSimOrderFromWireboard(){updateSimOrderFromSource(sourceFromWireboard())}function updateSimOrderFromSource(t){simOrder=generateExecutionOrderFromSource(t)}function simStep(){cycIdx++;for(var t=0;t<simOrder.length;t++){var e=simOrder[t],o=components.filter(t=>t.id==e.id)[0];if(o)if(o.run()){var n=wires.filter(t=>t.O.component===o);for(var i in n){var s=n[i];if(s){var r=s.I,a=s.O;r.component.setIn(r.ID,a.component.getOut(a.ID))}}}}}function generateExecutionOrderFromSource(t){var e=[],o=generateChildrensOfSourceComponents(t),n=getAloneComponentsFromSource(t);for(var i in n){var s=n[i];e.push(s),e=generateOrderFromSourceComponent(o,s,e)}return e.reverse()}function generateChildrensOfSourceComponents(t){var e={};for(var o in t.components){var n=t.components[o],i=t.wires.filter(t=>t.I.component==n.id);if(i.length>0){var s={};for(var r in i){var a=i[r].O.component;s[a]||a==n.id||(s[a]=t.components.filter(t=>t.id==a)[0])}e[n.id]=s}}return e}function generateOrderFromSourceComponent(t,e,o,n){o||(o=[]),n||(n=[]),n.push(e);var i=t[e.id];for(var s in i){var r=i[s];if(r&&!n.includes(r)){if(o.includes(r)){var a=o.indexOf(r);o.splice(a,1)}o.push(r),generateOrderFromSourceComponent(t,r,o,n)}}return n.pop(),o}function getAloneComponentsFromSource(t){var e=[];for(var o in t.components){var n=t.components[o];0==t.wires.filter(t=>t.O.component==n.id).length&&e.push(n)}return e}var simInterval=50,simEvent=function(){simStep(),setTimeout(simEvent,simInterval)};setTimeout(simEvent,simInterval),setInterval(function(){for(var t=0;t<components.length;t++){var e=components[t];e instanceof INPUT||e instanceof OUTPUT||e.refresh()}},250);var openFile=function(t){var e=t.target,o=new FileReader;o.onload=function(){var t=o.result;loadProject(JSON.parse(t))},o.readAsText(e.files[0])},openAsLib=function(t){var e=t.target,o=new FileReader;o.onload=function(){var t=o.result;prompt({title:"Enter new component name",value:"empty"}).then(e=>{null!=e&&""!=e&&(e in toolbox?alert("Component alredy exists!"):loadProjectAsComponent(e,JSON.parse(t)))}).catch(console.error)},o.readAsText(e.files[0])};function download(t,e,o){var n=new Blob([t],{type:o});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(n,e);else{var i=document.createElement("a"),s=URL.createObjectURL(n);i.href=s,i.download=e,document.body.appendChild(i),i.click(),setTimeout(function(){document.body.removeChild(i),window.URL.revokeObjectURL(s)},0)}}$("#modalComponentOptions").on("shown.bs.modal",function(){$("#modalComponentOptions input").first().trigger("focus")}),$(window).bind("beforeunload",function(){return"Are you sure you want to leave?"});class WireConnection{constructor(t,e,o){this.from=t,this.to=e,this.container=o,this.svg=this.container.path("").fill("none").stroke({width:1}).addClass("wire"),this.from.parent().on("dragmove",this.update,this),this.to.parent().on("dragmove",this.update,this),this.update()}update(){var t=this.from,e=this.to,o=t.cx()+this.from.parent().x(),n=t.cy()+this.from.parent().y(),i=e.cx()+this.to.parent().x(),s=e.cy()+this.to.parent().y();if(i<o){var r=i;i=o,o=r;var a=s;s=n,n=a}var l="Mfcx,fcy Cxa,ya xb,yb tcx,tcy";l=l.replace("fcx",o).replace("fcy",n).replace("xa",(o+i)/2-10).replace("ya",n).replace("xb",(o+i)/2+10).replace("yb",s).replace("tcx",i).replace("tcy",s),this.svg.plot(l)}remove(){this.svg.remove()}}class CONST extends Component{constructor(t=null){super(0,1),this.minHeight=3,this.value="",t&&(this.value=t.value)}createConfigModal(){return`\n            <div class="form-group">\n              <input id="constValue" type="text" class="form-control" placeholder="Value" value="${this.value}">\n            </div>\n            `}applyConfig(t){var e=$("#constValue").val();return null!=e&&""!=e&&(this.value=e,this.valueSVG.text(this.value.toString())),!0}drawBody(t,e){this.svgBody=this.svg.rect(t,e).radius(2).move(0,0).fill("#cccccc").stroke({color:"#666666",width:2}),this.valueSVG=this.svg.text(this.value.toString()).font({family:"Menlo",size:12,anchor:"middle"}).move(t/2,0)}execute(){this.outputs[0].value=this.value}getConfig(){return{value:this.value}}}class INPUT extends Component{constructor(t=null){super(0,1),this.alias="",t&&(this.alias=t.alias)}createConfigModal(){return`\n            <div class="form-group">\n              <input id="aliasValue" type="text" class="form-control" placeholder="Alias" value="${this.alias}">\n            </div>\n            `}applyConfig(t){var e=$("#aliasValue").val();return null!=e&&""!=e&&(this.alias=e,this.aliasSVG.text(this.alias)),!0}drawBody(t,e){this.svgBody=this.svg.rect(t,e).radius(2).move(0,0).fill("#cccccc").stroke({color:"#666666",width:2}),this.aliasSVG=this.svg.text(this.alias).font({family:"Menlo",size:12,anchor:"middle"}).move(t/2,-15)}getConfig(){return{alias:this.alias}}}class OUTPUT extends Component{constructor(t=null){super(1,0),this.alias="",t&&(this.alias=t.alias)}createConfigModal(){return`\n            <div class="form-group">\n              <input id="aliasValue" type="text" class="form-control" placeholder="Alias" value="${this.alias}">\n            </div>\n            `}applyConfig(t){var e=$("#aliasValue").val();return null!=e&&""!=e&&(this.alias=e,this.aliasSVG.text(this.alias)),!0}drawBody(t,e){this.svgBody=this.svg.rect(t,e).radius(2).move(0,0).fill("#cccccc").stroke({color:"#666666",width:2}),this.aliasSVG=this.svg.text(this.alias).font({family:"Menlo",size:12,anchor:"middle"}).move(t/2,-15)}getConfig(){return{alias:this.alias}}}class BUTTON extends Component{constructor(t=null){super(0,1),this.minWidth=5,this.minHeight=5,this.btnSVG=null,this.outputs[0].value=0}drawSymbol(t){this.btnSVG=t.rect(24,24).radius(6).fill("#ccc").stroke({color:"#666",width:2}),t.size(24,24)}mouseDownEvent(t){this.btnSVG.fill("#888"),this.outputs[0].value=1}mouseUpEvent(t){this.btnSVG.fill("#ccc"),this.outputs[0].value=0}mouseDblClickEvent(t){return!0}}class TOGGLE extends Component{constructor(t=null){super(0,1),this.minWidth=5,this.minHeight=5,this.btnSVG=null,this.outputs[0].value=0}drawSymbol(t){this.btnSVG=t.rect(24,24).radius(6).fill("#ccc").stroke({color:"#666",width:2}),t.size(24,24)}mouseDownEvent(t){this.btnSVG.fill("#888")}mouseUpEvent(t){this.btnSVG.fill("#ccc"),this.outputs[0].value=!this.outputs[0].value}mouseDblClickEvent(t){return!0}}class CLOCK extends Component{constructor(t=null){super(0,1),this.interval=10,t&&(this.interval=+t.interval),this.lastTimestamp=Math.floor(Date.now())}execute(){var t=Math.floor(Date.now());t-this.lastTimestamp>this.interval&&(this.outputs[0].value=!this.outputs[0].value,this.lastTimestamp=t)}createConfigModal(){return`\n            <div class="form-group">\n              <input id="constValue" ng-model="yourName" type="number" class="form-control" placeholder="Value" value="${this.interval}">\n            </div>\n            `}applyConfig(t){var e=$("#constValue").val();return null!=e&&""!=e&&(this.interval=+e,this.svgName.text(this.interval.toString())),!0}getConfig(){return{interval:this.interval}}}class R_TRIG extends Component{constructor(t=null){super(1,1),this.lastValue=0}execute(){this.outputs[0].value=this.inputs[0].value!=this.lastValue&&+this.inputs[0].value,this.lastValue=this.inputs[0].value}}class TRI_Component extends Component{constructor(){super(["I","En"],[],["Q"])}execute(){var t=+this.inputs[2].value;this.outputs[0].value=t?this.inputs[1].value:null}}class LED extends Component{constructor(t=null){super(1,0),this.minWidth=5,this.minHeight=5,this.ledSVG=null,this.value=null}drawSymbol(t){this.ledSVG=t.circle(24).fill("#3f0000").stroke({color:"#330000",width:2}),t.size(24,24)}execute(){this.value=+this.inputs[0].value}draw(){+this.value?this.ledSVG.fill("#ff0000").stroke({color:"#cc0000",width:2}):this.ledSVG.fill("#3f0000").stroke({color:"#330000",width:2})}}class Disp_7Seg extends Component{constructor(t=null){super(["A","B","C","D","E","F","G","."],0),this.minWidth=12,this.ledSVG=null}drawSymbol(t){this.ledSVG=new SVG.G,this.ledSVG.rect(636,1e3).fill("#000"),this.segA=this.ledSVG.path("M 575 138 L 494 211 L 249 211 L 194 137 L 213 120 L 559 120 Z"),this.segB=this.ledSVG.path("M 595 160 L 544 452 L 493 500 L 459 456 L 500 220 L 582 146 Z"),this.segC=this.ledSVG.path("M 525 560 L 476 842 L 465 852 L 401 792 L 441 562 L 491 516 Z"),this.segD=this.ledSVG.path("M 457 860 L 421 892 L 94 892 L 69 864 L 144 801 L 394 801 Z"),this.segE=this.ledSVG.path("M 181 560 L 141 789 L 61 856 L 48 841 L 96 566 L 148 516 Z"),this.segF=this.ledSVG.path("M 241 218 L 200 453 L 150 500 L 115 454 L 166 162 L 185 145 Z"),this.segG=this.ledSVG.path("M 485 507 L 433 555 L 190 555 L 156 509 L 204 464 L 451 464 Z"),this.segDOT=this.ledSVG.circle(92).move(496,794),this.segA.fill("#3f0000"),this.segB.fill("#3f0000"),this.segC.fill("#3f0000"),this.segD.fill("#3f0000"),this.segE.fill("#3f0000"),this.segF.fill("#3f0000"),this.segG.fill("#3f0000"),this.segDOT.fill("#3f0000"),this.ledSVG.scale(.1,.1),t.add(this.ledSVG),t.size(63.6,100)}draw(){this.segA.fill(+this.inputs[0].value?"#ff0000":"#3f0000"),this.segB.fill(+this.inputs[1].value?"#ff0000":"#3f0000"),this.segC.fill(+this.inputs[2].value?"#ff0000":"#3f0000"),this.segD.fill(+this.inputs[3].value?"#ff0000":"#3f0000"),this.segE.fill(+this.inputs[4].value?"#ff0000":"#3f0000"),this.segF.fill(+this.inputs[5].value?"#ff0000":"#3f0000"),this.segG.fill(+this.inputs[6].value?"#ff0000":"#3f0000"),this.segDOT.fill(+this.inputs[7].value?"#ff0000":"#3f0000")}}class BCD_7Seg extends Component{constructor(t=null){super(["","","",""],0),this.minWidth=6,this.ledSVG=null,this.segMap=[63,6,91,79,102,109,125,7,127,103,119,124,57,94,121,113],this.segData=0}drawSymbol(t){this.ledSVG=new SVG.G,this.ledSVG.rect(636,1e3).fill("#000"),this.segA=this.ledSVG.path("M 575 138 L 494 211 L 249 211 L 194 137 L 213 120 L 559 120 Z"),this.segB=this.ledSVG.path("M 595 160 L 544 452 L 493 500 L 459 456 L 500 220 L 582 146 Z"),this.segC=this.ledSVG.path("M 525 560 L 476 842 L 465 852 L 401 792 L 441 562 L 491 516 Z"),this.segD=this.ledSVG.path("M 457 860 L 421 892 L 94 892 L 69 864 L 144 801 L 394 801 Z"),this.segE=this.ledSVG.path("M 181 560 L 141 789 L 61 856 L 48 841 L 96 566 L 148 516 Z"),this.segF=this.ledSVG.path("M 241 218 L 200 453 L 150 500 L 115 454 L 166 162 L 185 145 Z"),this.segG=this.ledSVG.path("M 485 507 L 433 555 L 190 555 L 156 509 L 204 464 L 451 464 Z"),this.segDOT=this.ledSVG.circle(92).move(496,794),this.segA.fill("#3f0000"),this.segB.fill("#3f0000"),this.segC.fill("#3f0000"),this.segD.fill("#3f0000"),this.segE.fill("#3f0000"),this.segF.fill("#3f0000"),this.segG.fill("#3f0000"),this.segDOT.fill("#3f0000"),this.ledSVG.scale(.05,.05),t.add(this.ledSVG),t.size(31.8,50)}execute(){for(var t=0,e=0;e<this.inputs.length;e++){t|=+this.inputs[e].value?1<<e:0}this.segData=this.segMap[t]}draw(){this.segA.fill(1&this.segData?"#ff0000":"#3f0000"),this.segB.fill(2&this.segData?"#ff0000":"#3f0000"),this.segC.fill(4&this.segData?"#ff0000":"#3f0000"),this.segD.fill(8&this.segData?"#ff0000":"#3f0000"),this.segE.fill(16&this.segData?"#ff0000":"#3f0000"),this.segF.fill(32&this.segData?"#ff0000":"#3f0000"),this.segG.fill(64&this.segData?"#ff0000":"#3f0000")}}class NOT_Component extends Component{constructor(t=null){super(1,1)}drawSymbol(t){}execute(){this.outputs[0].value=!+this.inputs[0].value}}class AND_Component extends Component{constructor(t=null){var e=2;t&&(e=t.inputsCount),e<2&&(e=2),super(e,1)}drawSymbol(t){t.svg('<path d="M 0 0 Q 16 0 16 8 Q 16 16 0 16 L 0 0 Z"></path>').size(16,16).fill("#cccccc").stroke({color:"#000",width:1})}execute(){for(var t=!!Boolean(+this.inputs[0].value),e=1;e<this.inputs.length;e++)t=t&&!!Boolean(+this.inputs[e].value);this.outputs[0].value=t?1:0}getConfig(){return{inputsCount:this.inputs.length}}openConfig(t){}}class NAND_Component extends Component{constructor(t=null){var e=2;t&&(e=t.inputsCount),e<2&&(e=2),super(e,1)}drawSymbol(t){t.svg('<path d="M 0 0 Q 14 0 14 8 Q 14 16 0 16 L 0 0 Z"></path><circle cx="15" cy="8" r="2"></circle>').size(17,16).fill("#cccccc").stroke({color:"#000",width:1})}execute(){for(var t=!!Boolean(+this.inputs[0].value),e=1;e<this.inputs.length;e++)t=t&&!!Boolean(+this.inputs[e].value);this.outputs[0].value=t?0:1}getConfig(){return{inputsCount:this.inputs.length}}openConfig(t){}}class OR_Component extends Component{constructor(t=null){var e=2;t&&(e=t.inputsCount),e<2&&(e=2),super(e,1)}drawSymbol(t){t.svg('<path d="M 0 0 Q 12.8 0 16 8 Q 12.8 16 0 16 Q 3.2 16 3.2 8 Q 3.2 0 0 0 Z"></path>').size(16,16).fill("#cccccc").stroke({color:"#000",width:1})}execute(){for(var t=!!Boolean(+this.inputs[0].value),e=1;e<this.inputs.length;e++)t=t||!!Boolean(+this.inputs[e].value);this.outputs[0].value=t?1:0}getConfig(){return{inputsCount:this.inputs.length}}openConfig(t){}}class NOR_Component extends Component{constructor(t=null){var e=2;t&&(e=t.inputsCount),e<2&&(e=2),super(e,1)}drawSymbol(t){t.svg('<path d="M 0 0 Q 11.2 0 14 8 Q 11.2 16 0 16 Q 2.8 16 2.8 8 Q 2.8 0 0 0 Z"></path><circle cx="15" cy="8" r="2"></circle>').size(17,16).fill("#cccccc").stroke({color:"#000",width:1})}execute(){for(var t=!!Boolean(+this.inputs[0].value),e=1;e<this.inputs.length;e++)t=t||!!Boolean(+this.inputs[e].value);this.outputs[0].value=t?0:1}getConfig(){return{inputsCount:this.inputs.length}}openConfig(t){}}class XOR_Component extends Component{constructor(t=null){var e=2;t&&(e=t.inputsCount),e<2&&(e=2),super(e,1)}drawSymbol(t){t.svg('<path d="M 3 0 Q 13.4 0 16 8 Q 13.4 16 3 16 Q 5.6 16 5.6 8 Q 5.6 0 3 0 Z"></path><path d="M 0 16 Q 2.6 16 2.6 8 Q 2.6 0 0 0"></path>').size(16,16).fill("#cccccc").stroke({color:"#000",width:1})}execute(){for(var t=!!Boolean(+this.inputs[0].value),e=1;e<this.inputs.length;e++)t^=!!Boolean(+this.inputs[e].value);this.outputs[0].value=t?1:0}getConfig(){return{inputsCount:this.inputs.length}}openConfig(t){}}class XNOR_Component extends Component{constructor(t=null){var e=2;t&&(e=t.inputsCount),e<2&&(e=2),super(e,1)}drawSymbol(t){t.svg('<path d="M 3 0 Q 11.8 0 14 8 Q 11.8 16 3 16 Q 5.2 16 5.2 8 Q 5.2 0 3 0 Z"></path><path d="M 0 16 Q 2.2 16 2.2 8 Q 2.2 0 0 0"></path><circle cx="16" cy="8" r="2"></circle>').size(16,16).fill("#cccccc").stroke({color:"#000",width:1})}execute(){for(var t=!!Boolean(+this.inputs[0].value),e=1;e<this.inputs.length;e++)t^=!!Boolean(+this.inputs[e].value);this.outputs[0].value=t?0:1}getConfig(){return{inputsCount:this.inputs.length}}openConfig(t){}}class SR_Component extends Component{constructor(){super(["S","R"],["Q"])}init(){this._c0=new NOR_Component,this._c1=new NOR_Component}execute(){this._c0.setIn(0,this.inputs[1].value),this._c0.setIn(1,this._c1.getOut(0)),this._c1.setIn(0,this._c0.getOut(0)),this._c1.setIn(1,this.inputs[0].value),this.outputs[0].value=this._c0.getOut(0)}}class RAM_Component extends Component{constructor(){super(["A0","A1","A2","A3","A4","A5","A6","A7","A8","A9","A10","A11","A12","A13","A14","A15","CS","OE","RW"],[],["D0","D1","D2","D3","D4","D5","D6","D7"]),this.minWidth=10,this.ram=Array(Math.pow(2,16)).fill(0),this.ram[65532]=0,this.ram[65533]=16,this.ram[4096]=230,this.ram[4097]=0,this.ram[4098]=76,this.ram[4099]=0,this.ram[4100]=16}execute(){for(var t=+this.inputs[24].value,e=+this.inputs[25].value,o=+this.inputs[26].value,n=0,i=0;i<16;i++)n|=+this.inputs[i+8].value?1<<i:0;for(i=0;i<8;i++)this.outputs[i].value=null;if(t)if(o){if(e){var s=this.ram[n];for(i=0;i<8;i++)this.outputs[i].value=s>>i&1}}else{var r=0;for(i=0;i<8;i++)r|=+this.inputs[i].value?1<<i:0;this.ram[n]=r}}openConfig(t){var e=prompt("Enter value @ 3",0);null!=e&&""!=e&&(this.ram[3]=+e)}}class CPU6502_Component extends Component{constructor(){super(["RST","CLK"],["A0","A1","A2","A3","A4","A5","A6","A7","A8","A9","A10","A11","A12","A13","A14","A15","RW"],["D0","D1","D2","D3","D4","D5","D6","D7"]),this.minWidth=10,this.lastRST_state=0,this.lastCLK_state=0,this.cpu=new CPU6502.CPU6502,this.cpu.md_component=this,this.cpu.read=function(t){this.md_component.outputs[24].value=1;for(var e=0;e<16;e++)this.md_component.outputs[e+8].value=t>>e&1;simStep();var o=0;for(e=0;e<8;e++)o|=+this.md_component.inputs[e].value?1<<e:0;return o},this.cpu.write=function(t,e){for(var o=0;o<16;o++)this.md_component.outputs[o+8].value=t>>o&1;for(o=0;o<8;o++)this.md_component.outputs[o].value=e>>o&1;simStep(),this.md_component.outputs[24].value=0}}execute(){1==+this.inputs[8].value&&0==this.lastRST_state?(this.lastRST_state=+this.inputs[8].value,this.cpu.reset()):this.lastRST_state=+this.inputs[8].value,1==+this.inputs[9].value&&0==this.lastCLK_state?(this.lastCLK_state=+this.inputs[9].value,this.cpu.step()):this.lastCLK_state=+this.inputs[9].value}}class ToBus_Component extends Component{constructor(t=null){var e=8;t&&(e=t.size),e<2&&(e=2),super(e,1);for(var o=0;o<e;o++)this.inputs[o].name="D"+o;this.outputs[0].name="Bus"}execute(){for(var t=[],e=0;e<this.inputs.length;e++)t.push(this.inputs[e].value);this.outputs[0].value=t}}class FromBus_Component extends Component{constructor(t=null){var e=8;t&&(e=t.size),e<2&&(e=2),super(1,e),this.inputs[0].name="Bus";for(var o=0;o<e;o++)this.outputs[o].name="D"+o}execute(){var t=this.inputs[0].value;if(t)for(var e=0;e<t.length;e++)this.outputs[e].value=t[e]}}class BIN2DEC_Component extends Component{constructor(t=null){var e=8;t&&(e=t.size),e<2&&(e=2),super(e,1);for(var o=0;o<e;o++)this.inputs[o].name="D"+o;this.outputs[0].name="Bus"}execute(){for(var t=0,e=0;e<this.inputs.length;e++){t|=+this.inputs[e].value?1<<e:0}this.outputs[0].value=t}}class DEC2BIN_Component extends Component{constructor(t=null){var e=8;t&&(e=t.size),e<2&&(e=2),super(1,e),this.inputs[0].name="Bus";for(var o=0;o<e;o++)this.outputs[o].name="D"+o}execute(){for(var t=this.inputs[0].value,e=0;e<this.outputs.length;e++)this.outputs[e].value=t>>e&1}}class PIN_IN extends Component{constructor(t=null){super(0,1),this.pinNumber=0,t&&(this.pinNumber=t.pinNumber)}createSVG(){super.createSVG(),this.svgName.text(this.pinNumber.toString())}createConfigModal(){return`\n            <div class="form-group">\n              <input id="constValue" ng-model="yourName" type="number" class="form-control" placeholder="Value" value="${this.pinNumber}">\n            </div>\n            `}applyConfig(t){var e=$("#constValue").val();return null!=e&&""!=e&&(this.pinNumber=+e,this.svgName.text(this.pinNumber.toString())),!0}getConfig(){return{pinNumber:this.pinNumber}}}class PIN_OUT extends Component{constructor(t=null){super(1,0),this.group="Focus",this.pinNumber=0,t&&(this.pinNumber=t.pinNumber)}createSVG(){super.createSVG(),this.svgName.text(this.pinNumber.toString())}createConfigModal(){return`\n            <div class="form-group">\n              <input id="constValue" ng-model="yourName" type="number" class="form-control" placeholder="Value" value="${this.pinNumber}">\n            </div>\n            `}applyConfig(t){var e=$("#constValue").val();return null!=e&&""!=e&&(this.pinNumber=+e,this.svgName.text(this.pinNumber.toString())),!0}getConfig(){return{pinNumber:this.pinNumber}}}CONST.group="MessyDesk",INPUT.group="MessyDesk",OUTPUT.group="MessyDesk",LED.group="Leds",Disp_7Seg.group="Leds",BCD_7Seg.group="Leds",TRI_Component.group="Gates",NOT_Component.group="Gates",AND_Component.group="Gates",NAND_Component.group="Gates",OR_Component.group="Gates",NOR_Component.group="Gates",XOR_Component.group="Gates",XNOR_Component.group="Gates",PIN_IN.group="Focus Board",PIN_OUT.group="Focus Board";var toolbox={CONST:CONST,INPUT:INPUT,OUTPUT:OUTPUT,TOGGLE:TOGGLE,BUTTON:BUTTON,CLOCK:CLOCK,R_TRIG:R_TRIG,LED:LED,Disp_7Seg:Disp_7Seg,BCD_7Seg:BCD_7Seg,NOT_Component:NOT_Component,AND_Component:AND_Component,NAND_Component:NAND_Component,OR_Component:OR_Component,NOR_Component:NOR_Component,XOR_Component:XOR_Component,XNOR_Component:XNOR_Component,TRI_Component:TRI_Component,SR_Component:SR_Component,RAM_Component:RAM_Component,CPU6502_Component:CPU6502_Component,ToBus_Component:ToBus_Component,FromBus_Component:FromBus_Component,BIN2DEC_Component:BIN2DEC_Component,DEC2BIN_Component:DEC2BIN_Component,PIN_IN:PIN_IN,PIN_OUT:PIN_OUT},toolbox_original=Object.assign({},toolbox);drawGroupedToolbox();